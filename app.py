import gradio as gr
from langchain_community.chat_models import ChatOllama
from langchain.memory import ConversationBufferWindowMemory
from langchain.prompts import ChatPromptTemplate, SystemMessagePromptTemplate, HumanMessagePromptTemplate, MessagesPlaceholder
from langchain.chains import LLMChain
import os
import time # –î–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ "–ø–µ—á–∞—Ç–∏"

# --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LangChain ---

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω–∞ —Å –º–æ–¥–µ–ª—å—é deepseek-coder
# –ó–∞–º–µ–Ω–∏—Ç–µ 'deepseek-coder' –Ω–∞ –∏–º—è –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –æ–Ω–æ –¥—Ä—É–≥–æ–µ
LLM_MODEL = "deepseek-coder"
try:
    llm = ChatOllama(model=LLM_MODEL)
    # –ü—Ä–æ–±–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
    llm.invoke("Hello!")
    print(f"–ú–æ–¥–µ–ª—å '{LLM_MODEL}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ Ollama.")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ Ollama ('{LLM_MODEL}'): {e}")
    print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω–∞ –∏ –º–æ–¥–µ–ª—å '{LLM_MODEL}' –¥–æ—Å—Ç—É–ø–Ω–∞.")
    # –ú–æ–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É
    llm = None # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

# –ü–∞–º—è—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ K=5 –ø–∞—Ä —Å–æ–æ–±—â–µ–Ω–∏–π)
memory = ConversationBufferWindowMemory(
    k=5,                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º—ã—Ö –ø–∞—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
    return_messages=True, # –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    memory_key="history"  # –ö–ª—é—á –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ
)

# –ü—Ä–æ–º–ø—Ç-—à–∞–±–ª–æ–Ω: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è LLM
system_message = """You are a helpful AI coding assistant powered by DeepSeek-coder, named Elcoder.
Your goal is to assist users with programming tasks.
You can write code, explain code snippets, find bugs, refactor code, and discuss programming concepts.
If the user provides content from a file, use that content as context for their request.
Format code blocks clearly using Markdown (e.g., ```python ... ```).
Be concise and accurate in your responses."""

prompt = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(system_message), # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
    MessagesPlaceholder(variable_name="history"),              # –ú–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    HumanMessagePromptTemplate.from_template("{input}")        # –ú–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (+ –∫–æ–Ω—Ç–µ–Ω—Ç —Ñ–∞–π–ª–∞)
])

# –¶–µ–ø–æ—á–∫–∞ LangChain: –°–≤—è–∑—ã–≤–∞–µ—Ç LLM, –ü—Ä–æ–º–ø—Ç –∏ –ü–∞–º—è—Ç—å
if llm: # –°–æ–∑–¥–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ LLM –¥–æ—Å—Ç—É–ø–Ω–∞
    chain = LLMChain(
        llm=llm,
        prompt=prompt,
        memory=memory,
        verbose=True # –í—ã–≤–æ–¥–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–±–æ—Ç–µ —Ü–µ–ø–æ—á–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    )
else:
    chain = None # –¶–µ–ø–æ—á–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –µ—Å–ª–∏ LLM –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å

# --- 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ñ–∞–π–ª–∞ ---
# –í –ø—Ä–æ—Å—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ.
latest_file_content = None
latest_file_name = None

# --- 3. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Gradio ---

def handle_file_upload(file_obj):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    global latest_file_content, latest_file_name
    if file_obj is not None:
        try:
            # file_obj –≤ Gradio - —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª. –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∏–º—è.
            filepath = file_obj.name
            filename = os.path.basename(filepath) # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞

            # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
            with open(filepath, 'r', encoding='utf-8') as f:
                latest_file_content = f.read()
            latest_file_name = filename

            print(f"–§–∞–π–ª '{latest_file_name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω. –†–∞–∑–º–µ—Ä: {len(latest_file_content)} –±–∞–π—Ç.")
            # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∞–∑–º–µ—Ä–µ —Ñ–∞–π–ª–∞ (—Ç–æ–∫–µ–Ω—ã LLM –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã)
            if len(latest_file_content) > 10000: # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ø–æ—Ä–æ–≥
                 return f"‚ö†Ô∏è –§–∞–π–ª '{latest_file_name}' –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –æ–Ω –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç."
            return f"‚úÖ –§–∞–π–ª '{latest_file_name}' –∑–∞–≥—Ä—É–∂–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É."

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{filepath}': {e}")
            latest_file_content = None
            latest_file_name = None
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}"
    else:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        latest_file_content = None
        latest_file_name = None
        return "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –æ—á–∏—â–µ–Ω."


def chat_logic(message, chat_history):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —á–∞—Ç–∞. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –≤—Ö–æ–¥ –¥–ª—è LangChain, –≤—ã–∑—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.
    """
    global latest_file_content, latest_file_name

    print(f"\n--- –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ---")
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message}")
    # print(f"–ò—Å—Ç–æ—Ä–∏—è –¥–æ –∑–∞–ø—Ä–æ—Å–∞: {chat_history}") # –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è Gradio

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ LLM
    if not chain:
        return "–û—à–∏–±–∫–∞: –ú–æ–¥–µ–ª—å LLM –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—É—Å–∫ Ollama –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏."

    input_for_chain = message

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
    if latest_file_content:
        print(f"–î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞: {latest_file_name}")
        file_context = f"Context from file '{latest_file_name}':\n```\n{latest_file_content}\n```\n\n"
        input_for_chain = file_context + f"User query: {message}"
        # –í–∞–∂–Ω–æ: –†–µ—à–∏—Ç–µ, –Ω—É–∂–Ω–æ –ª–∏ –æ—á–∏—â–∞—Ç—å —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
        # –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å, –æ–Ω –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–æ –≤—Å–µ–º –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–∞–º, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏–ª–∏ –Ω–µ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å".
        # –ï—Å–ª–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ, —Ñ–∞–π–ª –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑:
        # latest_file_content = None
        # latest_file_name = None
        # print("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∏ –æ—á–∏—â–µ–Ω –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.")

    print(f"–ü–æ–ª–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è LLMChain:\n{input_for_chain[:500]}...") # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –≤—Ö–æ–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    try:
        # –í—ã–∑—ã–≤–∞–µ–º —Ü–µ–ø–æ—á–∫—É LangChain (–∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç LLM –∏ –ø–∞–º—è—Ç—å)
        # .invoke –æ–∂–∏–¥–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å
        response = chain.invoke({"input": input_for_chain})
        bot_response = response['text'] # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        print(f"–û—Ç–≤–µ—Ç LLM: {bot_response}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLMChain: {e}")
        bot_response = f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: {e}"

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—É (–∑–∞–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç) –≤ –∏—Å—Ç–æ—Ä–∏—é Gradio
    # chat_history.append((message, bot_response)) # Gradio —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

    # –ò–º–∏—Ç–∞—Ü–∏—è "–ø–µ—á–∞—Ç–∏" –¥–ª—è –ª—É—á—à–µ–≥–æ UX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # full_response = ""
    # for chunk in bot_response:
    #     full_response += chunk
    #     time.sleep(0.01)
    #     yield full_response

    return bot_response # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –±–æ—Ç–∞


def clear_chat_and_memory():
    """
    –û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –≤ Gradio, –ø–∞–º—è—Ç—å LangChain –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.
    """
    global latest_file_content, latest_file_name

    # –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ LangChain
    if memory:
        memory.clear()

    # –°–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞
    latest_file_content = None
    latest_file_name = None

    print("–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞, –ø–∞–º—è—Ç—å LangChain –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–∞–π–ª–∞ –æ—á–∏—â–µ–Ω—ã.")
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è Chatbot –∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è Textbox + —Å—Ç–∞—Ç—É—Å
    return [], "", "–ò—Å—Ç–æ—Ä–∏—è –∏ –ø–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω—ã."

# --- 4. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Gradio ---

with gr.Blocks(theme=gr.themes.Soft()) as demo: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–º—É –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞
    gr.Markdown(
        f"""
        # ü§ñ Elcoder: –í–∞—à –õ–æ–∫–∞–ª—å–Ω—ã–π –ü–æ–º–æ—â–Ω–∏–∫ –ø–æ –ö–æ–¥—É ({LLM_MODEL} + Ollama)
        –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é, –≤—Å—Ç–∞–≤–ª—è–π—Ç–µ –∫–æ–¥ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
        """
    )

    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞
    chatbot = gr.Chatbot(
        label="–î–∏–∞–ª–æ–≥ —Å Elcoder",
        bubble_full_width=False, # –ü—É–∑—ã—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É
        height=500 # –í—ã—Å–æ—Ç–∞ –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞
        )

    with gr.Row(): # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Ä—è–¥
        # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        msg_textbox = gr.Textbox(
            label="–í–∞—à –∑–∞–ø—Ä–æ—Å –∫ Elcoder:",
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å...",
            lines=3, # –ù–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
            scale=7 # –ó–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å —Ä—è–¥–∞
            )
        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        file_upload_button = gr.UploadButton(
                "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª",
                file_types=['.py', '.txt', '.md', '.json', '.csv', '.html', '.css', '.js', '.java', '.c', '.cpp', '.h', '.hpp', '.rs', '.go', '.php'], # –£–∫–∞–∂–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã
                scale=1 # –ó–∞–Ω–∏–º–∞–µ—Ç –º–µ–Ω—å—à—É—é —á–∞—Å—Ç—å —Ä—è–¥–∞
            )

    # –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥"
    clear_button = gr.Button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –ø–∞–º—è—Ç—å")

    # –°—Ç–∞—Ç—É—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞)
    status_display = gr.Markdown("") # –ò—Å–ø–æ–ª—å–∑—É–µ–º Markdown –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    # --- –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ---

    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–∂–∞—Ç–∏–µ Enter –≤ Textbox –∏–ª–∏ –∫–ª–∏–∫ –ø–æ –Ω–µ–≤–∏–¥–∏–º–æ–π –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º streaming –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–µ—á–∞—Ç–∏ (–µ—Å–ª–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å yield –≤ chat_logic)
    msg_textbox.submit(
        chat_logic,                 # –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        [msg_textbox, chatbot],     # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
        [chatbot]                   # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, –µ—Å–ª–∏ yield)
    ).then(lambda: "", None, [msg_textbox], queue=False) # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

    # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    file_upload_button.upload(
        handle_file_upload,         # –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        [file_upload_button],       # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –æ–±—ä–µ–∫—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        [status_display],           # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏
        queue=False
    )

    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å"
    clear_button.click(
        clear_chat_and_memory,      # –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        [],                         # –ù–µ—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        [chatbot, msg_textbox, status_display], # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –æ—á–∏—â–µ–Ω–Ω—ã–π —á–∞—Ç, –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
        queue=False
    )

# --- 5. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
if __name__ == "__main__":
    print("–ó–∞–ø—É—Å–∫ Gradio –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Elcoder...")
    if not llm or not chain:
         print("\n*** –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: LLM –∏–ª–∏ LangChain –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞. ***\n")

    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Gradio
    demo.launch(server_name="0.0.0.0") # –î–æ—Å—Ç—É–ø–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "127.0.0.1" —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    # demo.launch() # –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
